<!DOCTYPE html>
<html>
<head>
    <title>å°è‚¡ä¸€éµåˆä½µæ’è¡Œ</title>
    <meta charset="big5">
    <style>
        *{margin:0;padding:0;box-sizing:border-box;}
        body{font-family:'å¾®è»Ÿæ­£é»‘é«”',Arial;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
        .container{max-width:1400px;margin:0 auto;background:white;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.3);overflow:hidden}
        .header{padding:30px;background:linear-gradient(90deg,#ff6b6b,#feca57);color:white;text-align:center}
        .header h1{font-size:28px;margin-bottom:10px}
        button{padding:12px 30px;font-size:18px;background:#28a745;color:white;border:none;border-radius:25px;cursor:pointer;transition:all 0.3s;font-weight:bold}
        button:hover{background:#218838;transform:translateY(-2px)}
        button:disabled{background:#ccc;cursor:not-allowed}
        .status{padding:20px;text-align:center;font-size:16px;font-weight:bold}
        .loading{color:#007bff}
        .success{color:#28a745}
        table{width:100%;border-collapse:collapse;margin-top:20px}
        th{background:#343a40;color:white;padding:15px;font-weight:bold;text-align:center}
        td{padding:12px 8px;border-bottom:1px solid #eee;text-align:right}
        .name{text-align:left !important;font-weight:bold}
        .positive{color:#28a745;font-weight:bold}
        .negative{color:#dc3545;font-weight:bold}
        .total{background:#ffc107 !important;font-weight:bold;font-size:16px}
        tr:hover{background:#f8f9fa}
        .code{font-family:monospace;background:#e9ecef;padding:2px 6px;border-radius:3px}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š å°è‚¡å€¼å¢+è²·è³£è¶…ä¸€éµåˆä½µæ’è¡Œ</h1>
            <p>å¯Œé‚¦è­‰åˆ¸è³‡æ–™è‡ªå‹•æŠ“å– | å¢æ¸›å€¼+å¤–è³‡+æŠ•ä¿¡+è‡ªç‡Ÿ+ä¸»åŠ›</p>
        </div>
        <div class="controls" style="padding:20px;background:#f8f9fa;text-align:center;border-bottom:1px solid #eee">
            <button onclick="loadData()" id="loadBtn">ğŸš€ ä¸€éµè¼‰å…¥æœ€æ–°è³‡æ–™</button>
            <span style="margin-left:20px;font-size:14px;color:#666">ä¸Šæ¬¡æ›´æ–°ï¼š<span id="lastUpdate">-</span></span>
        </div>
        <div id="status" class="status">æŒ‰éˆ•é–‹å§‹è¼‰å…¥è³‡æ–™</div>
        <div style="padding:20px;overflow:auto">
            <table id="rankTable">
                <thead>
                    <tr>
                        <th style="width:60px">åæ¬¡</th>
                        <th style="width:200px">è‚¡ç¥¨</th>
                        <th>å¢æ¸›å€¼(è¬å…ƒ)</th>
                        <th>å¤–è³‡(å¼µ)</th>
                        <th>æŠ•ä¿¡(å¼µ)</th>
                        <th>è‡ªç‡Ÿ(å¼µ)</th>
                        <th>ä¸»åŠ›(å¼µ)</th>
                        <th class="total">ç¸½åˆ†æ•¸</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        const urls = {
            value: 'https://api.allorigins.win/raw?url=' + encodeURIComponent('https://fubon-ebrokerdj.fbs.com.tw/Z/ZG/ZG_C.djhtm'),
            foreign: 'https://api.allorigins.win/raw?url=' + encodeURIComponent('https://fubon-ebrokerdj.fbs.com.tw/Z/ZG/ZG_D.djhtm'),
            trust: 'https://api.allorigins.win/raw?url=' + encodeURIComponent('https://fubon-ebrokerdj.fbs.com.tw/Z/ZG/ZG_DD.djhtm'),
            dealer: 'https://api.allorigins.win/raw?url=' + encodeURIComponent('https://fubon-ebrokerdj.fbs.com.tw/Z/ZG/ZG_DB.djhtm'),
            major: 'https://api.allorigins.win/raw?url=' + encodeURIComponent('https://fubon-ebrokerdj.fbs.com.tw/Z/ZG/ZG_F.djhtm')
        };

        async function fetchPage(url) {
            try {
                const response = await fetch(url, {cache: 'no-cache'});
                if (!response.ok) throw new Error('ç¶²è·¯éŒ¯èª¤');
                return await response.text();
            } catch(e) {
                console.error('æŠ“å–å¤±æ•—:', e);
                return null;
            }
        }

        function parseValueTable(html) {
            if (!html) return [];
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const rows = Array.from(doc.querySelectorAll('tr'));
            return rows
                .filter(row => row.querySelectorAll('td').length >= 8)
                .map(row => {
                    const tds = row.querySelectorAll('td');
                    const text = tds[1].textContent;
                    const codeMatch = text.match(/(d{4})/);
                    const code = codeMatch ? codeMatch[1] : '';
                    if (!code) return null;
                    const name = text.replace(/d{4}/, '').replace(/^s+|s+$/g, '');
                    const incValStr = tds[7].textContent.replace(/[^d,]/g, '').replace(/,/g, '');
                    const incVal = parseFloat(incValStr) || 0;
                    return { code, name, incValue: incVal };
                })
                .filter(Boolean)
                .slice(0, 100);
        }

        function parseNetBuyTable(html) {
            if (!html) return {};
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const rows = Array.from(doc.querySelectorAll('tr'));
            const data = {};
            rows.forEach(row => {
                const tds = row.querySelectorAll('td');
                if (tds.length >= 7) {
                    const text = tds[1].textContent;
                    const codeMatch = text.match(/(d{4})/);
                    const code = codeMatch ? codeMatch[1] : '';
                    if (code) {
                        const netBuyStr = tds[tds.length-1].textContent.replace(/[^d,-]/g, '');
                        data[code] = parseInt(netBuyStr) || 0;
                    }
                }
            });
            return data;
        }

        async function loadData() {
            const btn = document.getElementById('loadBtn');
            const status = document.getElementById('status');
            btn.disabled = true;
            btn.textContent = 'è¼‰å…¥ä¸­...';
            status.textContent = 'ğŸ”„ æ­£åœ¨æŠ“å–5å€‹è³‡æ–™ä¾†æº...';
            status.className = 'status loading';

            try {
                const [valueHtml, foreignHtml, trustHtml, dealerHtml, majorHtml] = 
                    await Promise.all([
                        fetchPage(urls.value),
                        fetchPage(urls.foreign),
                        fetchPage(urls.trust),
                        fetchPage(urls.dealer),
                        fetchPage(urls.major)
                    ]);

                status.textContent = 'ğŸ“Š è§£æè³‡æ–™ä¸¦è¨ˆç®—ç¸½åˆ†...';

                const valueData = parseValueTable(valueHtml);
                const foreignData = parseNetBuyTable(foreignHtml);
                const trustData = parseNetBuyTable(trustHtml);
                const dealerData = parseNetBuyTable(dealerHtml);
                const majorData = parseNetBuyTable(majorHtml);

                const combined = valueData.map(stock => {
                    const f = foreignData[stock.code] || 0;
                    const t = trustData[stock.code] || 0;
                    const d = dealerData[stock.code] || 0;
                    const m = majorData[stock.code] || 0;
                    
                    const totalScore = stock.incValue * 1000 + 
                                     Math.abs(f * 1500000) + 
                                     Math.abs(t * 1500000) + 
                                     Math.abs(d * 1500000) + 
                                     Math.abs(m * 1500000);
                    
                    return {
                        code: stock.code,
                        name: stock.name,
                        incValue: stock.incValue,
                        foreign: f,
                        trust: t,
                        dealer: d,
                        major: m,
                        totalScore
                    };
                })
                .filter(s => s.totalScore > 0)
                .sort((a, b) => b.totalScore - a.totalScore)
                .slice(0, 50);

                displayTable(combined);
                status.textContent = `âœ… è¼‰å…¥å®Œæˆï¼æ‰¾åˆ° ${valueData.length} æª”å€¼å¢è‚¡ç¥¨ï¼Œé¡¯ç¤ºå‰50å`;
                status.className = 'status success';
                document.getElementById('lastUpdate').textContent = new Date().toLocaleString('zh-TW');
            } catch(e) {
                status.textContent = 'âŒ è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šå¾Œé‡è©¦';
                status.className = 'status error';
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸš€ ä¸€éµè¼‰å…¥æœ€æ–°è³‡æ–™';
            }
        }

        function displayTable(data) {
            const tbody = document.querySelector('#rankTable tbody');
            tbody.innerHTML = data.map((stock, idx) => `
                <tr>
                    <td>${idx + 1}</td>
                    <td class="name"><span class="code">${stock.code}</span> ${stock.name}</td>
                    <td>${Math.round(stock.incValue).toLocaleString()}</td>
                    <td class="${stock.foreign >= 0 ? 'positive' : 'negative'}">${stock.foreign.toLocaleString()}</td>
                    <td class="${stock.trust >= 0 ? 'positive' : 'negative'}">${stock.trust.toLocaleString()}</td>
                    <td class="${stock.dealer >= 0 ? 'positive' : 'negative'}">${stock.dealer.toLocaleString()}</td>
                    <td class="${stock.major >= 0 ? 'positive' : 'negative'}">${stock.major.toLocaleString()}</td>
                    <td class="total">${stock.totalScore.toLocaleString()}</td>
                </tr>
            `).join('');
        }

        window.addEventListener('load', () => {
            setTimeout(loadData, 1000);
        });
    </script>
</body>
</html>
